@model EiSorteei.Data.Produto

@{
    ViewBag.Title = "EiSorteei";
    Layout = "~/Views/Shared/_LayoutComprar.cshtml";

    List<string> Comprados = ViewBag.Comprados;
    var Usuario = ViewBag.Usuario;
}

<style>
    body {
        background: #1F1F1F;
    }

    #Rifas {
        width: 100%;
        justify-content: center;
        margin: auto;
    }

    .NumeroRifa {
        background-color: #E0C777;
        width: 14%;
        color: #fff;
        margin: 5px;
        font-size: 28px;
        text-align: center;
        border-radius: 20px;
        transition: all .3s ease-in-out;
        cursor: pointer;
    }

        .NumeroRifa:hover {
            background-color: #1F1F1F;
        }

    .carousel {
        display: flex;
        align-items: center;
        flex-direction: row;
    }

    .informacoes {
        color: #fff;
        width: 60%;
        margin: auto;
    }

    #Arrows {
        margin-bottom: 10px;
    }

    #next, #prev {
        background-color: #E0C777;
        border-radius: 50%;
        padding: 10px 16px 10px 16px;
        margin: 10px;
        cursor: pointer;
    }

    .ErroComprar {
        color: red;
        display: none;
    }

    @@media only screen and (max-width: 1000px) {
        .imagem_produto {
            width: 100% !important;
        }

        .NumeroRifa {
            width: 12%;
            font-size: 14px;
        }
    }

    .box_premio {
        background-color: #535151;
        padding: 10px;
        border-radius: 24px;
        margin-bottom: 10px;
    }

    .btn-default {
        background-color: #535151;
        border: none;
        color: white;
    }
</style>


<section class="blog-container" style="padding-bottom:0;">
    <div class="center">
        <div class="upper-box">
            <h1>Escolha o número da sua Rifa</h1>
        </div>
    </div>
</section>

<section>
    <div class="carousel" align="center">

        @foreach (var x in ViewBag.Imagens)
        {
            <div><img src="~/Content/ImagemProdutos/@x.Caminho" alt="Imagem do Produto" style="width:30%;" class="imagem_produto" /></div>
        }

    </div>


</section>

<div class="informacoes">

    <div align="center" id="Arrows">
        <i class="fas fa-chevron-left fa-2x" id="prev"></i>
        <i class="fas fa-chevron-right fa-2x" id="next"></i>
    </div>

    <h5 align="center">Informações Importante</h5>
    <p align="center">Confira abaixo as formas de pagamento, regras, contatos e tudo sobre o sorteio</p>

    <div class="form-group text-center">
        <button class="btn btn-default" id="btnInformacoes" style="background-color: #E0C777"><i class="fas fa-info"></i> Informações do Item</button>
        <button class="btn btn-default" id="btnDadosPagamento"><i class="fas fa-search-dollar"></i> Dados de Pagamento</button>
        <button class="btn btn-default" id="btnRegulamento"><i class="fas fa-cogs"></i> Regulamento/Descrição</button>
        <button class="btn btn-default" id="btnContato"><i class="fas fa-envelope"></i> Contato</button>
    </div>

    <div id="DadosPagamento" class="box_premio" style="display:none;">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam ut nisl non ligula auctor faucibus. Vestibulum ante ipsum primis in
        faucibus orci luctus et ultrices posuere cubilia curae; Morbi vitae turpis at purus viverra finibus. Sed suscipit orci lacus, in volutpat sapien
        tincidunt ut. In hac habitasse platea dictumst. Aliquam laoreet aliquet odio, vel finibus risus. Orci varius natoque penatibus et magnis dis parturient montes,
        nascetur ridiculus mus. Fusce tincidunt leo in tortor fringilla, sed pretium lorem sodales. Nam finibus volutpat mattis. Morbi gravida at justo vitae pulvinar.
        Vivamus sed leo sed quam mattis euismod sit amet non velit.
    </div>

    <div id="Regulamento" style="display:none;" class="box_premio">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam ut nisl non ligula auctor faucibus. Vestibulum ante ipsum primis in
        faucibus orci luctus et ultrices posuere cubilia curae; Morbi vitae turpis at purus viverra finibus. Sed suscipit orci lacus, in volutpat sapien
        tincidunt ut. In hac habitasse platea dictumst. Aliquam laoreet aliquet odio, vel finibus risus. Orci varius natoque penatibus et magnis dis parturient montes,
        nascetur ridiculus mus. Fusce tincidunt leo in tortor fringilla, sed pretium lorem sodales. Nam finibus volutpat mattis. Morbi gravida at justo vitae pulvinar.
        Vivamus sed leo sed quam mattis euismod sit amet non velit.
    </div>

    <div id="InformacoesItem" class="box_premio row text-center">
        <div class="col-md-12 text-center form-group">
            <h3><i class="fas fa-trophy"></i> Prêmio: @Model.Nome</h3>
            <h4><i class="fas fa-tags"></i> Categoria: @ViewBag.Categoria</h4>
        </div>
        <div class="col-md-4 form-group">
            <strong>Valor Unitário: R$ @Math.Round(Model.ValorRifa, 2)</strong>
        </div>
        <div class="col-md-4 form-group">
            <strong>Total: @Model.RangeCodigo</strong>
        </div>
        <div class="col-md-4 form-group">
            <strong><i class="fas fa-hourglass-start"></i> Reservados: 6</strong>
        </div>

        <div class="col-md-4 form-group">
            <strong><i class="fas fa-calendar"></i> Data do Sorteio: @Model.DataSorteio.ToString().Replace(" 00:00:00",string.Empty)</strong>
        </div>

        <div class="col-md-4 form-group">
            <strong><i class="fas fa-map-marker-alt"></i> Cidade: @Usuario.Cidade</strong>
        </div>

        <div class="col-md-4 form-group">
            <strong><i class="far fa-map"></i> Estado: @Usuario.Estado</strong>
        </div>

    </div>

    <div id="Contato" style="display:none;" class="box_premio text-center">

        <p><i class="fas fa-envelope"></i> <strong>Email: @Usuario.Email</strong></p>

        <p><i class="fas fa-phone"></i> <strong>Telefone: @Usuario.Telefone</strong></p>

    </div>

    <div id="Rifas" class="row">

        @for (int x = 1; x <= Model.RangeCodigo; x++)
        {
            if (Session["Usuario"] != null)
            {
                <span class="NumeroRifa @(Comprados.Contains(x.ToString())?"":"Comprar")" data-numero="@x" style="@(Comprados.Contains(x.ToString())?"background-color:red;":"")">@x</span>
            }

            else
            {
                <a class="NumeroRifa" data-numero="@x" href="@Url.Action("Index","Usuario",new { IdProduto = Model.Id})" style="text-decoration:none; color:white; @(Comprados.Contains(x.ToString())?"background-color:red;":"")">@x</a>
            }

        }

    </div>
</div>


@section Scripts{

    <script>

        $(document).ready(function () {

            $("#DataCartao").mask("00/00");
            $("#CPFCartao").mask("000.000.000-00");

            $('.carousel').slick({
                autoplay: true,
                autoplaySpeed: 2000,
                nextArrow: '#next',
                prevArrow: '#prev'
            });


            $(".Comprar").click(function () {

                let Numero = $(this).attr("data-numero");
                $("#NumeroRifa").text(Numero);

                $("#ErroNumero").css("display", "none");
                $("#ErroTitulo").css("display", "none");
                $("#ErroData").css("display", "none");
                $("#ErroCVV").css("display", "none");
                $("#ErroCPF").css("display", "none");
                $("#ErroComprador").css("display", "none");

                $("#NumeroCartao").val("");
                $("#TituloCartao").val("");
                $("#DataCartao").val("");
                $("#CVVCartao").val("");
                $("#CPFCartao").val("");
                $("#CodigoVendedor").val("");

                $("#myModal2").css('display', "block");

            });

            $("#Fechar").click(function () {
                $("#myModal2").css('display', "none");
            });

            $("#EfetuarCompra").click(function () {

                let erro = false;

                let Numero = $("#NumeroCartao").val();
                let Titulo = $("#TituloCartao").val();
                let Data = $("#DataCartao").val();
                let CVV = $("#CVVCartao").val();
                let CPF = $("#CPFCartao").val();
                let CodigoVendedor = $("#CodigoVendedor").val();

                if (!Numero) {
                    $("#ErroNumero").css("display", "block");
                    erro = true;
                }

                else {
                    $("#ErroNumero").css("display", "none");
                }


                if (!Titulo) {
                    $("#ErroTitulo").css("display", "block");
                    erro = true;
                }

                else {
                    $("#ErroTitulo").css("display", "none");
                }


                if (!Data) {
                    $("#ErroData").css("display", "block");
                    erro = true;
                }

                else {
                    $("#ErroData").css("display", "none");
                }

                if (!CVV) {
                    $("#ErroCVV").css("display", "block");
                    erro = true;
                }

                else {
                    $("#ErroCVV").css("display", "none");
                }

                if (!CPF) {
                    $("#ErroCPF").css("display", "block");
                }

                else {
                    $("#ErroCPF").css("display", "none");
                }


                if (!erro) {

                    let DataFormatada = Data.split("/");
                    let CPFFormatado = CPF.replace(".", "").replace(".", "").replace("-", "");

                    let MesCartao = DataFormatada[0];
                    let AnoCartao = DataFormatada[1];

                    window.Mercadopago.setPublishableKey("APP_USR-4f22958e-cccd-49ac-b52d-02ae9b9697a9");
                    window.Mercadopago.getIdentificationTypes();

                    let DadosCartao = {

                        cardNumber: Numero,
                        cardExpirationMonth: MesCartao,
                        cardExpirationYear: AnoCartao,
                        securityCode: CVV,
                        cardholderName: Titulo,
                        docType: "CPF",
                        docNumber: CPFFormatado

                    };


                    var hash = window.Mercadopago.createToken(DadosCartao, setCardTokenAndPay);

                    function setCardTokenAndPay(status, response) {
                        if (status == 200 || status == 201) {

                            let IdProduto = "@Model.Id";

                            let Usuario = "";

                            $.ajax({
                                url: "@Url.Action("GetDadosUsuario", "Comprar")",
                                method: "POST",
                                data: { IdProduto: IdProduto },
                                success: function (retorno) {
                                    Usuario = retorno;
                                },
                                complete: function () {

                                    let CodigoCartao = response.id;

                                    let Telefone = Usuario.Telefone;
                                    Telefone = Telefone.replace("(", "").replace(')', "");
                                    let TelefoneFormatado = Telefone.split(" ");

                                    let dados = JSON.stringify({
                                        token: CodigoCartao,
                                        installments: 1,
                                        transaction_amount: Usuario.ValorRifa,
                                        description: "Bilhete EiSorteei - " + Usuario.NomeProduto,
                                        payment_method_id: "visa",
                                        payer: {
                                            email: Usuario.Email,
                                            identification: {
                                                number: CPFFormatado,
                                                type: "CPF"
                                            }
                                        },
                                        notification_url: "https://www.suaurl.com/notificacoes/",
                                        sponsor_id: null,
                                        binary_mode: false,
                                        external_reference: "Bilhete " + Usuario.IdProduto,
                                        statement_descriptor: "Bilhete EiSorteei",
                                        additional_info: {
                                            items: [
                                                {
                                                    id: "PR0001",
                                                    title: "Bilhete EiSorteei - Código do Produto: " + Usuario.IdProduto,
                                                    description: "Bilhete EiSorteei",
                                                    picture_url: "https://http2.mlstatic.com/resources/frontend/statics/growth-sellers-landings/device-mlb-point-i_medium@2x.png",
                                                    category_id: "Bilhete",
                                                    quantity: 1,
                                                    unit_price: Usuario.ValorRifa
                                                }
                                            ],
                                            payer: {
                                                first_name: Usuario.Nome,
                                                last_name: Usuario.SobreNome,
                                                address: {
                                                    zip_code: Usuario.CEP,
                                                    street_name: Usuario.Rua,
                                                    street_number: Usuario.Numero
                                                },
                                                registration_date: Usuario.DataCadastro,
                                                phone: {
                                                    area_code: TelefoneFormatado[0],
                                                    number: TelefoneFormatado[1]
                                                }
                                            },
                                            shipments: {
                                                receiver_address: {
                                                    street_name: "Av. Alberane Cunha",
                                                    street_number: 81,
                                                    zip_code: "37350000",
                                                    city_name: "Liberdade",
                                                    state_name: "Minas Gerais"
                                                }
                                            }
                                        }
                                    });

                                    $.ajax({
                                        url: "https://api.mercadopago.com/v1/payments",
                                        method: 'POST',
                                        beforeSend: function (xhr) {
                                            xhr.setRequestHeader('Authorization', 'Bearer APP_USR-5017428128263404-072015-ddd04542ab6288891aebac5789addf33-247787081');
                                        },
                                        data: dados,
                                        success: function (retorno) {

                                            if (retorno.status == "approved" || retorno.status == "in_process") {

                                                let NumeroRifa = $("#NumeroRifa").text();

                                                $.ajax({
                                                    url: "@Url.Action("RegistrarCompra","Comprar")",
                                                    method: "POST",
                                                    data: { IdProduto: Usuario.IdProduto, CodigoVendedor: CodigoVendedor, IdCompra: retorno.id, NumeroRifa: NumeroRifa },
                                                    success: function (data) {
                                                        if (data.Status) {

                                                            if (retorno.status == "approved") {
                                                                Swal.fire({
                                                                    title: 'Pagamento Efetuado',
                                                                    text: "Seu pagamento foi aceito, obrigado pela sua compra fique atento para a data do sorteio e boa sorte.",
                                                                    icon: 'success',
                                                                    showCancelButton: false,
                                                                    confirmButtonColor: '#3085d6',
                                                                    cancelButtonColor: '#d33',
                                                                    cancelButtonText: 'Não',
                                                                    confirmButtonText: 'OK'
                                                                });
                                                            }

                                                            if (retorno.status == "in_process") {
                                                                Swal.fire({
                                                                    title: 'Pagamento em Análise',
                                                                    text: "Seu pagamento está sendo analisado, quando seu pagamento for aprovado você receberá um email confirmando seu pagamento.",
                                                                    icon: 'success',
                                                                    showCancelButton: false,
                                                                    confirmButtonColor: '#3085d6',
                                                                    cancelButtonColor: '#d33',
                                                                    cancelButtonText: 'Não',
                                                                    confirmButtonText: 'OK'
                                                                });
                                                            }

                                                            $("#myModal2").css('display', "none");
                                                        }
                                                    }
                                                });
                                            }

                                            else {
                                                Swal.fire({
                                                    title: 'Pagamento não efetuado',
                                                    text: "Seu pagamento não foi aceito, entre em contato com o distribuinte do seu cartão e tente novamente mais tarde.",
                                                    icon: 'error',
                                                    showCancelButton: false,
                                                    confirmButtonColor: '#3085d6',
                                                    cancelButtonColor: '#d33',
                                                    cancelButtonText: 'Não',
                                                    confirmButtonText: 'OK'
                                                });
                                            }
                                        },
                                        error: function (retorno) {
                                            Swal.fire({
                                                title: 'Cartão Inválido',
                                                text: "Os dados do cartão informado não são inválidos, por favor verifique seus dados e tente novamente!",
                                                icon: 'error',
                                                showCancelButton: false,
                                                confirmButtonColor: '#3085d6',
                                                cancelButtonColor: '#d33',
                                                cancelButtonText: 'Não',
                                                confirmButtonText: 'OK'
                                            });
                                        }
                                    });


                                }
                            });

                        }

                        else {
                            Swal.fire({
                                title: 'Cartão Inválido',
                                text: "Os dados do cartão informado não são inválidos, por favor verifique seus dados e tente novamente!",
                                icon: 'error',
                                showCancelButton: false,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                cancelButtonText: 'Não',
                                confirmButtonText: 'OK'
                            });
                        }
                    };
                }

            });

            $("#btnDadosPagamento").click(function () {

                $(this).css("background-color", "#E0C777");
                $("#btnRegulamento").css("background-color", "#535151");
                $("#btnInformacoes").css("background-color", "#535151");
                $("#btnContato").css("background-color", "#535151");


                $("#DadosPagamento").slideDown(200);
                $("#Regulamento").slideUp(200);
                $("#InformacoesItem").slideUp(200);
                $("#Contato").slideUp(200);

            });

            $("#btnRegulamento").click(function () {

                $(this).css("background-color", "#E0C777");
                $("#btnDadosPagamento").css("background-color", "#535151");
                $("#btnInformacoes").css("background-color", "#535151");
                $("#btnContato").css("background-color", "#535151");

                $("#DadosPagamento").slideUp(200);
                $("#Regulamento").slideDown(200);
                $("#InformacoesItem").slideUp(200);
                $("#Contato").slideUp(200);

            });

            $("#btnInformacoes").click(function () {

                $(this).css("background-color", "#E0C777");
                $("#btnRegulamento").css("background-color", "#535151");
                $("#btnDadosPagamento").css("background-color", "#535151");
                $("#btnContato").css("background-color", "#535151");

                $("#DadosPagamento").slideUp(200);
                $("#Regulamento").slideUp(200);
                $("#InformacoesItem").slideDown(200);
                $("#Contato").slideUp(200);

            });

            $("#btnContato").click(function () {

                $(this).css("background-color", "#E0C777");
                $("#btnRegulamento").css("background-color", "#535151");
                $("#btnInformacoes").css("background-color", "#535151");
                $("#btnDadosPagamento").css("background-color", "#535151");

                $("#DadosPagamento").slideUp(200);
                $("#Regulamento").slideUp(200);
                $("#InformacoesItem").slideUp(200);
                $("#Contato").slideDown(200);

            });
        });





    </script>

}
